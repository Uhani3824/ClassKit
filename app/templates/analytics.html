{% extends "base.html" %}

{% block title %}Analytics - {{ course.title }}{% endblock %}

{% block extra_head %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="fade-in">
    <a href="/courses/{{ course.id }}"
        style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--primary-color); text-decoration: none; margin-bottom: 1rem; font-weight: 500;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        Back to Course
    </a>

    <div class="course-header" style="margin-bottom: 2rem;">
        <h1>Analytics Dashboard</h1>
        <p style="color: var(--text-secondary);">{{ course.title }} ({{ course.code }})</p>
    </div>

    <!-- KPI Cards -->
    <div class="grid"
        style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card glass">
            <h4 style="color: var(--text-secondary);">Total Students</h4>
            <div id="kpi-students"
                style="font-size: 2.5rem; font-weight: 700; margin-top: 0.5rem; color: var(--primary-color);">--</div>
        </div>
        <div class="card glass">
            <h4 style="color: var(--text-secondary);">Total Assignments</h4>
            <div id="kpi-assignments"
                style="font-size: 2.5rem; font-weight: 700; margin-top: 0.5rem; color: var(--accent-color);">--</div>
        </div>
        <div class="card glass">
            <h4 style="color: var(--text-secondary);">Upcoming Deadlines</h4>
            <div id="kpi-deadlines" style="font-size: 2.5rem; font-weight: 700; margin-top: 0.5rem; color: #f59e0b;">--
            </div>
        </div>

    </div>

    <!-- Engagement Analytics -->
    <div class="card glass" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">Student Engagement (Last 7 Days)</h3>
        <div style="height: 300px;">
            <canvas id="engagementChart"></canvas>
        </div>
    </div>

    <!-- Assignment Analytics Grid -->
    <div class="grid"
        style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Submission Status -->
        <div class="card glass">
            <h3 style="margin-bottom: 1.5rem;">Submission Status</h3>
            <div style="height: 250px; display: flex; justify-content: center;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Grade Distribution -->
        <div class="card glass">
            <h3 style="margin-bottom: 1.5rem;">Grade Distribution</h3>
            <div style="height: 250px;">
                <canvas id="gradesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Assignment Difficulty Table -->
    <div class="card glass">
        <h3 style="margin-bottom: 1.5rem;">Assignment Insights</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="text-align: left; border-bottom: 2px solid var(--border-color);">
                        <th style="padding: 1rem;">Assignment</th>
                        <th style="padding: 1rem;">Submissions</th>
                        <th style="padding: 1rem;">Avg Grade</th>
                        <th style="padding: 1rem;">Status</th>
                    </tr>
                </thead>
                <tbody id="difficulty-table-body">
                    <!-- Injected via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const token = localStorage.getItem('token');
    const courseId = {{ course.id }};

    // Colors
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();

    async function loadDashboard() {
        try {
            const res = await fetch(`/api/v1/analytics/course/${courseId}/dashboard-full`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Failed to load analytics");

            const data = await res.json();

            // 1. Update KPIs
            document.getElementById('kpi-students').innerText = data.kpis.total_students;
            document.getElementById('kpi-assignments').innerText = data.kpis.total_assignments;
            document.getElementById('kpi-deadlines').innerText = data.kpis.upcoming_deadlines;

            // 2. Engagement Chart
            const timelineData = data.engagement_timeline;
            new Chart(document.getElementById('engagementChart'), {
                type: 'line',
                data: {
                    labels: timelineData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Posts',
                            data: timelineData.map(d => d.posts),
                            borderColor: primaryColor,
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Submissions',
                            data: timelineData.map(d => d.submissions),
                            borderColor: accentColor,
                            backgroundColor: 'rgba(234, 67, 53, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            // 3. Submission Status Chart
            const statusData = data.assignment_stats.status_breakdown || { submitted: 0, late: 0, missing: 0 };
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Submitted', 'Late', 'Missing'],
                    datasets: [{
                        data: [statusData.submitted, statusData.late, statusData.missing],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 4. Grades Chart
            const gradesData = data.assignment_stats.grades_distribution || { A: 0, B: 0, C: 0, D: 0, F: 0 };
            new Chart(document.getElementById('gradesChart'), {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D', 'F'],
                    datasets: [{
                        label: 'Submission Count',
                        data: [gradesData.A, gradesData.B, gradesData.C, gradesData.D, gradesData.F],
                        backgroundColor: primaryColor,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            // 5. Insights Table
            const tableBody = document.getElementById('difficulty-table-body');
            data.difficulty_indicators.forEach(item => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #eee';

                // Determine status flag
                let status = '<span style="color: #10b981; font-weight: 500;">Good</span>';
                if (item.avg_grade < 60) status = '<span style="color: #ef4444; font-weight: 500;">Needs Attention</span>';
                else if (item.avg_grade < 75) status = '<span style="color: #f59e0b; font-weight: 500;">Moderate</span>';

                tr.innerHTML = `
                    <td style="padding: 1rem;">${item.title}</td>
                    <td style="padding: 1rem;">${item.submission_count}</td>
                    <td style="padding: 1rem;">${item.avg_grade}%</td>
                    <td style="padding: 1rem;">${status}</td>
                `;
                tableBody.appendChild(tr);
            });

        } catch (e) {
            console.error(e);
            // alert("Error loading dashboard data");
        }
    }

    loadDashboard();
</script>
{% endblock %}