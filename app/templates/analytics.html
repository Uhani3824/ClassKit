{% extends "base.html" %}

{% block title %}Analytics - {{ course.title }}{% endblock %}

{% block content %}
<a href="/courses/{{ course.id }}"
    style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--primary-color); text-decoration: none; margin-bottom: 1rem; font-weight: 500;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
    </svg>
    Back to Course
</a>
<div class="course-header" style="margin-bottom: 2rem;">
    <h1>Course Analytics</h1>
    <p style="color: var(--text-secondary);">{{ course.title }}</p>
</div>

<div class="course-nav">
    <a href="/courses/{{ course.id }}" class="course-nav-item">Stream</a>
    <a href="/courses/{{ course.id }}/classwork" class="course-nav-item">Classwork</a>
    <a href="#" class="course-nav-item">People</a>
</div>

<div class="grid" style="margin-bottom: 2rem;">
    <div class="card glass animate-fade">
        <h4 style="color: var(--text-secondary);">Enrolled Students</h4>
        <div id="enrolled_count" style="font-size: 2.5rem; font-weight: 700; margin-top: 1rem;">--</div>
    </div>
    <div class="card glass animate-fade" style="animation-delay: 0.1s;">
        <h4 style="color: var(--text-secondary);">Engagement (Last 7 Days)</h4>
        <div id="engagement_summary" style="margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Posts</span> <strong id="post_count">0</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Announcements</span> <strong id="announcement_count">0</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Comments</span> <strong id="comment_count">0</strong>
            </div>
        </div>
    </div>
</div>

<div class="card glass animate-fade" style="animation-delay: 0.2s;">
    <h3 style="margin-bottom: 1.5rem;">Recent Activity Timeline (48h)</h3>
    <div id="activity_list" style="display: flex; flex-direction: column; gap: 1rem;">
        <p style="color: var(--text-secondary);">Loading activity...</p>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const token = localStorage.getItem('token');
    const courseId = {{ course.id }};

    async function loadAnalytics() {
        const res = await fetch(`/api/v1/analytics/course/${courseId}/analytics`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            const data = await res.json();
            document.getElementById('enrolled_count').innerText = data.enrolled_students;
            document.getElementById('post_count').innerText = data.activity_summary.post_count;
            document.getElementById('announcement_count').innerText = data.activity_summary.announcement_count;
            document.getElementById('comment_count').innerText = data.activity_summary.comment_count;
        }

        const dashRes = await fetch('/api/v1/analytics/teacher/dashboard', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (dashRes.ok) {
            const dashData = await dashRes.json();
            const list = document.getElementById('activity_list');
            list.innerHTML = '';
            if (dashData.recent_activity.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary);">No recent activity recorded.</p>';
            } else {
                dashData.recent_activity.forEach(act => {
                    const item = document.createElement('div');
                    item.style.padding = '1rem';
                    item.style.borderLeft = '4px solid var(--primary-color)';
                    item.style.background = '#f8f9fa';
                    item.style.borderRadius = '0 8px 8px 0';

                    const time = new Date(act.time).toLocaleString();
                    item.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600; text-transform: capitalize;">${act.type.replace('_', ' ')}</span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">${time}</span>
                    </div>
                `;
                    list.appendChild(item);
                });
            }
        }
    }

    loadAnalytics();
</script>
{% endblock %}