{% extends "base.html" %}

{% block title %}Dashboard - Class-Kit{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>My Classes</h1>
    {% if user.role == "teacher" %}
    <button class="btn btn-primary" onclick="showModal('createCourseModal')">Create Class</button>
    {% else %}
    <button class="btn btn-primary" onclick="showModal('joinCourseModal')">Join Class</button>
    {% endif %}
</div>

<div class="grid">
    {% for course in courses %}
    <a href="/courses/{{ course.id }}" style="text-decoration: none; color: inherit;">
        <div class="card glass animate-fade"
            style="height: 200px; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom right, #4285f4, #1a73e8); color: white;">
            <div>
                <h2 style="margin-bottom: 0.5rem;">{{ course.title }}</h2>
                <p style="opacity: 0.9;">{{ course.section or "" }}</p>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.8rem;">CODE: {{ course.code }}</span>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7" />
                </svg>
            </div>
        </div>
    </a>
    {% endfor %}
</div>

<!-- Create Course Modal -->
<div id="createCourseModal" class="modal"
    style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
    <div class="card splash" style="max-width: 500px; margin: 10% auto; background: white;">
        <h2>Create Course</h2>
        <form id="createCourseForm" style="margin-top: 1.5rem;">
            <div class="form-group">
                <label>Class Name (required)</label>
                <input type="text" id="course_title" required>
            </div>
            <div class="form-group">
                <label>Section</label>
                <input type="text" id="course_section">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="course_description"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" onclick="hideModal('createCourseModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Join Course Modal -->
<div id="joinCourseModal" class="modal"
    style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
    <div class="card splash" style="max-width: 400px; margin: 15% auto; background: white;">
        <h2>Join Class</h2>
        <p style="color: var(--text-secondary); margin-top: 0.5rem;">Ask your teacher for the class code, then enter it
            here.</p>
        <form id="joinCourseForm" style="margin-top: 1.5rem;">
            <div class="form-group">
                <label>Class Code</label>
                <input type="text" id="join_code" required minlength="7" maxlength="7">
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" onclick="hideModal('joinCourseModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Join</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    function showModal(id) { document.getElementById(id).style.display = 'block'; }
    function hideModal(id) { document.getElementById(id).style.display = 'none'; }

    const token = localStorage.getItem('token');

    document.getElementById('createCourseForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            title: document.getElementById('course_title').value,
            section: document.getElementById('course_section').value,
            description: document.getElementById('course_description').value
        };
        const res = await fetch('/api/v1/courses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        if (res.ok) window.location.reload();
    });

    document.getElementById('joinCourseForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('join_code').value;
        const res = await fetch(`/api/v1/courses/join/${code}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (res.ok) window.location.reload();
        else alert('Invalid code or already joined');
    });
</script>
{% endblock %}